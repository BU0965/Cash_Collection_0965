<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Collection and Monitoring Mechanism</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            padding: 25px 35px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(26, 115, 232, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(40%, -40%);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-size: 15px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
            background-color: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eef2f7;
        }
        
        .date-filter {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8fafc;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .date-filter label {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }
        
        .date-filter input {
            padding: 9px 14px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            color: #2d3748;
            font-weight: 500;
            transition: border 0.3s;
        }
        
        .date-filter input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 11px 22px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 9px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(243, 156, 18, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7b7d 100%);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(127, 140, 141, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
        }
        
        .data-table-container {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow-x: auto;
            border: 1px solid #eef2f7;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            min-width: 1200px;
        }
        
        .main-header th {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            color: white;
            padding: 18px 12px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #000000;
            position: relative;
            font-size: 15px;
        }
        
        .sub-header th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            font-size: 14px;
            font-weight: 500;
            padding: 14px 8px;
            border: 1px solid #000000;
            position: relative;
        }
        
        td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #000000;
            background-color: white;
            transition: background-color 0.2s;
            position: relative;
        }
        
        tr:not(.highlight-total):hover td {
            background-color: #f8fafc;
        }
        
        .collection-center {
            text-align: left;
            font-weight: 700;
            color: #1a73e8;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%) !important;
            font-size: 15px;
            padding-left: 20px;
            border-left: 4px solid #1a73e8;
        }
        
        .mode-row {
            background-color: white;
        }
        
        .mode-label {
            text-align: left;
            padding-left: 35px;
            font-weight: 600;
            color: #2d3748;
            position: relative;
        }
        
        .mode-label::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background-color: #4a90e2;
            border-radius: 50%;
        }
        
        .highlight-total {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
            color: white;
            font-weight: 700;
        }
        
        .highlight-total td {
            background: transparent !important;
            color: white;
        }
        
        .highlight-total .mode-label::before {
            background-color: white;
        }
        
        .remark-cell {
            width: 300px;
            min-width: 250px;
            max-width: 350px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal !important;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #4a5568;
            font-size: 14px;
            font-style: italic;
            padding: 10px 15px;
            text-align: left;
            vertical-align: top;
            line-height: 1.5;
        }
        
        .amount-cell {
            font-weight: 600;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }
        
        .footer {
            text-align: center;
            padding: 18px;
            color: #718096;
            font-size: 14px;
            margin-top: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eef2f7;
        }
        
        .footer span {
            color: #1a73e8;
            font-weight: 600;
        }
        
        .empty-cell {
            color: #a0aec0;
            font-style: italic;
        }
        
        .date-cell {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .table-shadow {
            position: absolute;
            bottom: -10px;
            left: 5%;
            width: 90%;
            height: 20px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 50%;
            z-index: -1;
        }
        
        .table-scroll-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
            padding: 5px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }
        
        @media (max-width: 1024px) {
            .table-scroll-indicator {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filter {
                justify-content: space-between;
                width: 100%;
            }
            
            .action-buttons {
                justify-content: center;
                width: 100%;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 13px;
            }
            
            h1 {
                font-size: 24px;
            }
        }

        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 14px 22px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            flex-direction: column;
            gap: 15px;
        }

        .loading-text {
            color: #4a5568;
            font-weight: 600;
        }

        .editable-cell {
            position: relative;
            cursor: pointer;
        }

        .edit-icon {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            color: #4a90e2;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 12px;
            background: white;
            padding: 2px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .editable-cell:hover .edit-icon {
            opacity: 1;
        }

        .edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .edit-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .password-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease;
            border: 1px solid #eef2f7;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .password-form input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            margin-bottom: 18px;
            font-size: 14px;
            background-color: #f8fafc;
            transition: all 0.3s;
        }

        .password-form input:focus {
            outline: none;
            border-color: #1a73e8;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .edit-mode-indicator {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .lock-mode-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .unlock-mode-btn {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        }

        .remark-editable-cell {
            background-color: #fffaf0;
            cursor: pointer;
            min-height: 80px;
            vertical-align: top;
            width: 300px;
            min-width: 250px;
            max-width: 350px;
            white-space: normal !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.5;
        }

        .remark-editable-cell:hover {
            background-color: #fff5e6;
        }

        .remark-textarea {
            width: 100%;
            height: 100%;
            min-height: 80px;
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            resize: vertical;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .remark-textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }
        
        /* Column widths for better layout */
        th:nth-child(1), td:nth-child(1) { width: 100px; } /* Date */
        th:nth-child(2), td:nth-child(2) { width: 70px; } /* Rcpt From */
        th:nth-child(3), td:nth-child(3) { width: 70px; } /* Rcpt To */
        th:nth-child(4), td:nth-child(4) { width: 80px; } /* Mode */
        th:nth-child(5), td:nth-child(5) { width: 70px; } /* Rcpt Count */
        th:nth-child(6), td:nth-child(6) { width: 90px; } /* Collection Amount */
        th:nth-child(7), td:nth-child(7) { width: 100px; } /* Deposit Date */
        th:nth-child(8), td:nth-child(8) { width: 100px; } /* Deposit Amount */
        th:nth-child(9), td:nth-child(9) { width: 70px; } /* Cancel Rcpt */
        th:nth-child(10), td:nth-child(10) { width: 90px; } /* Cancel Amount */
        th:nth-child(11), td:nth-child(11) { width: 300px; min-width: 250px; max-width: 350px; } /* Remark */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>Cash Collection and Monitoring Mechanism</h1>
                    <p class="subtitle">Track and manage collection center transactions efficiently</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="current-date-display" id="currentDateDisplay"></div>
                    <div id="editModeIndicator" class="edit-mode-indicator" style="display: none;">
                        <i class="fas fa-edit"></i> Edit Mode Active
                    </div>
                    <button class="btn btn-danger" id="githubConfigBtn" title="Configure GitHub API">
                        <i class="fab fa-github"></i> GitHub Setup
                    </button>
                </div>
            </div>
        </header>
        
        <div class="controls">
            <div class="date-filter">
                <label for="dateFilter"><i class="fas fa-calendar-alt"></i> Select Date:</label>
                <input type="date" id="dateFilter">
                <button class="btn btn-primary" id="loadDataBtn">
                    <i class="fas fa-sync-alt"></i> Load Data
                </button>
                <button class="btn btn-success" id="saveToGitHubBtn">
                    <i class="fas fa-cloud-upload-alt"></i> Save to GitHub
                </button>
                <button class="btn unlock-mode-btn" id="unlockEditBtn" style="display: none;">
                    <i class="fas fa-unlock"></i> Unlock Edit Mode
                </button>
                <button class="btn lock-mode-btn" id="lockEditBtn">
                    <i class="fas fa-lock"></i> Enter Password to Edit
                </button>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="chequeDataBtn">
                    <i class="fas fa-money-check-alt"></i> Cheque Data
                </button>
                <button class="btn btn-success" id="neftDataBtn">
                    <i class="fas fa-exchange-alt"></i> NEFT Data
                </button>
                <button class="btn btn-warning" id="bankStatementBtn">
                    <i class="fas fa-file-invoice-dollar"></i> Bank Statement
                </button>
                <button class="btn btn-info" id="dashboardBtn">
                    <i class="fas fa-chart-line"></i> Dashboard
                </button>
            </div>
        </div>
        
        <div class="data-table-container">
            <div class="table-scroll-indicator">
                <i class="fas fa-arrows-alt-h"></i> Scroll
            </div>
            <table id="collectionTable">
                <thead>
                    <tr class="main-header">
                        <th rowspan="2">Date</th>
                        <th colspan="2">Rcpt No</th>
                        <th rowspan="2">Mode</th>
                        <th colspan="2">Collection</th>
                        <th colspan="2">Deposited In Bank</th>
                        <th colspan="2">Cancel Rcpt</th>
                        <th rowspan="2">Remark</th>
                    </tr>
                    <tr class="sub-header">
                        <th>From</th>
                        <th>To</th>
                        <th>Rcpt</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Rcpt</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr id="loadingRow">
                        <td colspan="11">
                            <div class="loading-container">
                                <div class="loading"></div>
                                <div class="loading-text">Please select a date and click "Load Data"</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="table-shadow"></div>
        </div>

        <!-- Password Modal -->
        <div class="password-modal" id="passwordModal">
            <div class="password-modal-content">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
                    <h3 style="color: #2c3e50; font-size: 18px; font-weight: 700;">Enter Password to Unlock Edit Mode</h3>
                    <button class="close-modal" id="closePasswordModalBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0;">&times;</button>
                </div>
                <div class="password-form">
                    <input type="password" id="passwordInput" placeholder="Enter password (XXXX)" autocomplete="off">
                    <div class="form-buttons" style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-info" id="cancelPasswordBtn">Cancel</button>
                        <button class="btn btn-primary" id="submitPasswordBtn">Unlock Edit Mode</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GitHub Config Modal -->
        <div class="password-modal" id="githubConfigModal">
            <div class="password-modal-content">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
                    <h3 style="color: #2c3e50; font-size: 18px; font-weight: 700;">GitHub API Configuration</h3>
                    <button class="close-modal" id="closeGitHubModalBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0;">&times;</button>
                </div>
                <div class="password-form">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2d3748;">GitHub Personal Access Token:</label>
                        <input type="password" id="githubTokenInput" placeholder="Enter GitHub Personal Access Token" autocomplete="off">
                        <small style="display: block; margin-top: 5px; color: #718096;">
                            Create token at: <a href="https://github.com/settings/tokens" target="_blank" style="color: #1a73e8;">github.com/settings/tokens</a><br>
                            Required permissions: repo (full control of private repositories)
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2d3748;">Repository Details:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="githubUserInput" placeholder="GitHub Username" value="bu0965">
                            <input type="text" id="githubRepoInput" placeholder="Repository Name" value="Cash_Collection_0965">
                        </div>
                        <input type="text" id="githubBranchInput" placeholder="Branch Name" value="main" style="margin-bottom: 10px;">
                        <input type="text" id="githubFileName" placeholder="Excel File Name" value="Bank_Deposit.xlsx">
                    </div>
                    
                    <div class="form-buttons" style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-info" id="cancelGitHubBtn">Cancel</button>
                        <button class="btn btn-primary" id="saveGitHubConfigBtn">Save Configuration</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Cash Collection and Monitoring Mechanism &copy; 2023 | Last updated: <span id="currentDate"></span></p>
        </div>
    </div>

    <script>
        // GitHub configuration
        let GITHUB_CONFIG = {
            USER: "bu0965",
            REPO: "Cash_Collection_0965",
            BRANCH: "main",
            FILE_NAME: "Bank_Deposit.xlsx",
            TOKEN: null
        };
        
        // App configuration
        const PASSWORD = "3303";
        
        // Collection modes
        const MODES = ["Cash", "Cheque", "NEFT", "Total"];
        
        // Variables
        let bankDepositData = [];
        let isEditModeActive = false;
        let currentCentersData = [];
        let currentCollectionDate = '';
        let autoSaveTimer = null;
        let isGitHubConfigured = false;
        
        // Load GitHub configuration from localStorage
        function loadGitHubConfig() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    GITHUB_CONFIG.USER = config.USER || GITHUB_CONFIG.USER;
                    GITHUB_CONFIG.REPO = config.REPO || GITHUB_CONFIG.REPO;
                    GITHUB_CONFIG.BRANCH = config.BRANCH || GITHUB_CONFIG.BRANCH;
                    GITHUB_CONFIG.FILE_NAME = config.FILE_NAME || GITHUB_CONFIG.FILE_NAME;
                    GITHUB_CONFIG.TOKEN = config.TOKEN || null;
                    
                    isGitHubConfigured = !!GITHUB_CONFIG.TOKEN;
                    console.log('GitHub configuration loaded:', { ...GITHUB_CONFIG, TOKEN: GITHUB_CONFIG.TOKEN ? '***' + GITHUB_CONFIG.TOKEN.slice(-4) : null });
                } catch (e) {
                    console.error('Error loading GitHub config:', e);
                }
            }
        }
        
        // Save GitHub configuration to localStorage
        function saveGitHubConfig() {
            localStorage.setItem('githubConfig', JSON.stringify(GITHUB_CONFIG));
            isGitHubConfigured = !!GITHUB_CONFIG.TOKEN;
            console.log('GitHub configuration saved');
        }
        
        // Format date to DD-MM-YYYY for filename
        function formatDateForFileName(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
        
        // Format date to DD-MMM-YY for display
        function formatDateForDisplay(date) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const day = date.getDate().toString().padStart(2, '0');
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2);
            return `${day}-${month}-${year}`;
        }
        
        // Get CSV file URL for selected date
        function getCsvFileUrl(date) {
            const formattedDate = formatDateForFileName(date);
            return `https://raw.githubusercontent.com/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/${GITHUB_CONFIG.BRANCH}/CC_${formattedDate}.csv`;
        }
        
        // Get Bank Deposit Excel file URL
        function getBankDepositFileUrl() {
            return `https://raw.githubusercontent.com/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/${GITHUB_CONFIG.BRANCH}/${GITHUB_CONFIG.FILE_NAME}`;
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];
            
            // Handle different CSV formats
            const delimiter = csvText.includes(';') ? ';' : ',';
            
            // Extract headers
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                // Handle quoted values and split by delimiter
                const row = [];
                let inQuotes = false;
                let currentValue = '';
                
                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === delimiter && !inQuotes) {
                        row.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                row.push(currentValue.trim());
                
                const rowData = {};
                headers.forEach((header, index) => {
                    rowData[header] = row[index] || '';
                });
                
                data.push(rowData);
            }
            
            return data;
        }
        
        // Load bank deposit data from GitHub
        async function loadBankDepositData() {
            try {
                const url = getBankDepositFileUrl() + `?t=${Date.now()}`;
                console.log('Loading bank deposit data from:', url);
                const response = await fetch(url);
                
                if (response.ok) {
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(worksheet);
                    
                    bankDepositData = data.map(row => ({
                        collectionDate: row['Collection Date'] || '',
                        centerCode: row['Collection Center Code'] || '',
                        mode: row['Mode'] || 'Cash',
                        depositDate: row['Deposit Date'] || '',
                        depositAmount: row['Deposit Amount'] || 0,
                        remark: row['Remark'] || '',
                        entryDate: row['Entry Date'] || new Date().toISOString().split('T')[0]
                    }));
                    
                    console.log(`Loaded ${bankDepositData.length} bank deposit records from GitHub`);
                    return true;
                }
            } catch (error) {
                console.log('No existing bank deposit file found or error loading:', error);
                bankDepositData = [];
            }
            return false;
        }
        
        // Create Excel file from bank deposit data
        function createExcelFile() {
            // Prepare data with proper headers
            const exportData = bankDepositData.map(entry => ({
                'Collection Date': entry.collectionDate,
                'Collection Center Code': entry.centerCode,
                'Mode': entry.mode || 'Cash',
                'Deposit Date': entry.depositDate,
                'Deposit Amount': entry.depositAmount || 0,
                'Remark': entry.remark || '',
                'Entry Date': entry.entryDate
            }));
            
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Bank Deposits");
            
            // Generate Excel file
            const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            
            return excelBuffer;
        }
        
        // Convert array buffer to base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        
        // Save data to GitHub using GitHub API
        async function saveToGitHub() {
            if (!isGitHubConfigured) {
                showNotification('Please configure GitHub API first', 'warning');
                openGitHubConfigModal();
                return;
            }
            
            try {
                showNotification('Saving data to GitHub...', 'info');
                
                // Create Excel file
                const excelBuffer = createExcelFile();
                const base64Content = arrayBufferToBase64(excelBuffer);
                
                // First, try to get the existing file SHA
                let sha = null;
                try {
                    const getFileUrl = `https://api.github.com/repos/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/contents/${GITHUB_CONFIG.FILE_NAME}`;
                    const getResponse = await fetch(getFileUrl, {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                        console.log('Got existing file SHA:', sha);
                    }
                } catch (e) {
                    console.log('File does not exist yet, will create new file');
                }
                
                // Create or update file
                const updateUrl = `https://api.github.com/repos/${GITHUB_CONFIG.USER}/${GITHUB_CONFIG.REPO}/contents/${GITHUB_CONFIG.FILE_NAME}`;
                const message = `Update Bank Deposit data - ${new Date().toISOString()}`;
                
                const updateData = {
                    message: message,
                    content: base64Content,
                    branch: GITHUB_CONFIG.BRANCH
                };
                
                // Add SHA if file exists (for update)
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('GitHub API response:', result);
                    
                    // Also save to localStorage as backup
                    autoSaveData();
                    
                    showNotification('Data successfully saved to GitHub!', 'success');
                    
                    // Reload data to confirm
                    setTimeout(async () => {
                        await loadBankDepositData();
                        showNotification('Data reloaded from GitHub', 'info');
                    }, 2000);
                    
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('GitHub API error:', errorText);
                    showNotification(`GitHub API error: ${response.status}`, 'warning');
                    return false;
                }
                
            } catch (error) {
                console.error('Error saving to GitHub:', error);
                showNotification(`Error: ${error.message}`, 'warning');
                return false;
            }
        }
        
        // Auto-save data to localStorage
        function autoSaveData() {
            // Save to localStorage
            localStorage.setItem('bankDepositDataBackup', JSON.stringify(bankDepositData));
            
            // Also save a copy with timestamp for recovery
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            localStorage.setItem(`bankDepositDataBackup_${timestamp}`, JSON.stringify(bankDepositData));
            
            console.log('Auto-saved bank deposit data to localStorage');
        }
        
        // Get bank deposit for a specific center and mode
        function getBankDeposit(collectionDate, centerCode, mode) {
            return bankDepositData.find(entry => 
                entry.collectionDate === collectionDate &&
                entry.centerCode === centerCode &&
                entry.mode === mode
            );
        }
        
        // Get remark for a specific center
        function getRemark(collectionDate, centerCode) {
            // Try all modes in order of priority
            const modesToCheck = ['Cash', 'Cheque', 'NEFT', 'Total'];
            
            for (const mode of modesToCheck) {
                const deposit = getBankDeposit(collectionDate, centerCode, mode);
                if (deposit && deposit.remark && deposit.remark.trim() !== '') {
                    return deposit.remark;
                }
            }
            
            return '';
        }
        
        // Save bank deposit entry
        function saveBankDepositEntry(collectionDate, centerCode, mode, depositDate, depositAmount, remark) {
            // Remove existing entry if exists
            bankDepositData = bankDepositData.filter(entry => 
                !(entry.collectionDate === collectionDate &&
                  entry.centerCode === centerCode &&
                  entry.mode === mode)
            );
            
            // Add new entry
            const newEntry = {
                collectionDate: collectionDate,
                centerCode: centerCode,
                mode: mode,
                depositDate: depositDate || '',
                depositAmount: depositAmount ? parseFloat(depositAmount) : 0,
                remark: remark || '',
                entryDate: new Date().toISOString().split('T')[0]
            };
            
            bankDepositData.push(newEntry);
            
            // If remark is entered, save it for ALL modes
            if (remark && remark.trim() !== '') {
                // Save the same remark for all other modes
                const otherModes = MODES.filter(m => m !== mode);
                otherModes.forEach(otherMode => {
                    // Check if entry exists for this mode
                    let otherEntry = getBankDeposit(collectionDate, centerCode, otherMode);
                    
                    if (!otherEntry) {
                        // Create new entry with same remark
                        otherEntry = {
                            collectionDate: collectionDate,
                            centerCode: centerCode,
                            mode: otherMode,
                            depositDate: '',
                            depositAmount: 0,
                            remark: remark,
                            entryDate: new Date().toISOString().split('T')[0]
                        };
                        bankDepositData.push(otherEntry);
                    } else if (!otherEntry.remark || otherEntry.remark.trim() === '') {
                        // Update existing entry with same remark
                        otherEntry.remark = remark;
                    }
                });
            }
            
            // Auto-save data to localStorage
            autoSaveData();
            
            console.log(`Saved entry: ${collectionDate}, ${centerCode}, ${mode}, Deposit: ${depositDate}/${depositAmount}, Remark: "${remark}"`);
            
            return newEntry;
        }
        
        // Process CSV data for table display
        function processCSVData(csvData, collectionDate) {
            // Group data by collection center and mode
            const centersMap = new Map();
            
            csvData.forEach(row => {
                // Use Col Centre Code column
                const centerName = row['Col Centre Code'] || '';
                
                // Use Receipt Number column
                let receiptNo = 0;
                const receiptStr = row['Receipt Number'] || '';
                if (receiptStr) {
                    receiptNo = parseInt(receiptStr.replace(/[^\d]/g, '')) || 0;
                }
                
                // Use Mode column
                const mode = (row['Mode'] || '').toUpperCase();
                
                // Use Receipt Amount column
                let amount = 0;
                const amountStr = row['Receipt Amount'] || '';
                if (amountStr) {
                    // Remove commas and convert to number
                    amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
                }
                
                // Check for cancelled receipts - Use Modification column (J:J)
                const modification = (row['Modification'] || '').toUpperCase();
                const isCancelled = modification === 'CANCELLED';
                
                if (!centerName || centerName.trim() === '') return;
                
                const centerKey = centerName.trim();
                
                if (!centersMap.has(centerKey)) {
                    centersMap.set(centerKey, {
                        name: centerKey,
                        receipts: [],
                        cancelledReceipts: [],
                        cancelledAmounts: [],
                        modes: {
                            Cash: { receipts: [], amount: 0 },
                            Cheque: { receipts: [], amount: 0 },
                            NEFT: { receipts: [], amount: 0 },
                            Total: { receipts: [], amount: 0 }
                        }
                    });
                }
                
                const center = centersMap.get(centerKey);
                
                if (receiptNo > 0) {
                    center.receipts.push(receiptNo);
                    center.modes.Total.receipts.push(receiptNo);
                    
                    // Track cancelled receipts
                    if (isCancelled) {
                        center.cancelledReceipts.push(receiptNo);
                        center.cancelledAmounts.push(amount);
                    }
                }
                
                if (mode.includes('CASH')) {
                    center.modes.Cash.receipts.push(receiptNo);
                    center.modes.Cash.amount += amount;
                    center.modes.Total.amount += amount;
                    
                    // For cancelled Cash receipts
                    if (isCancelled) {
                        center.modes.Cash.cancelledReceipts = center.modes.Cash.cancelledReceipts || [];
                        center.modes.Cash.cancelledAmounts = center.modes.Cash.cancelledAmounts || [];
                        center.modes.Cash.cancelledReceipts.push(receiptNo);
                        center.modes.Cash.cancelledAmounts.push(amount);
                    }
                } else if (mode.includes('CHEQUE')) {
                    center.modes.Cheque.receipts.push(receiptNo);
                    center.modes.Cheque.amount += amount;
                    center.modes.Total.amount += amount;
                } else if (mode.includes('NEFT')) {
                    center.modes.NEFT.receipts.push(receiptNo);
                    center.modes.NEFT.amount += amount;
                    center.modes.Total.amount += amount;
                }
            });
            
            // Convert map to array and calculate statistics
            const centers = Array.from(centersMap.values()).map(center => {
                // Calculate min and max receipts for each mode
                Object.keys(center.modes).forEach(mode => {
                    const modeData = center.modes[mode];
                    modeData.count = modeData.receipts.length;
                    
                    if (modeData.receipts.length > 0) {
                        modeData.minReceipt = Math.min(...modeData.receipts);
                        modeData.maxReceipt = Math.max(...modeData.receipts);
                    } else {
                        modeData.minReceipt = 0;
                        modeData.maxReceipt = 0;
                    }
                    
                    // Calculate cancelled receipts for Cash mode
                    if (mode === 'Cash') {
                        modeData.cancelledCount = modeData.cancelledReceipts ? modeData.cancelledReceipts.length : 0;
                        modeData.cancelledAmount = modeData.cancelledAmounts ? 
                            modeData.cancelledAmounts.reduce((sum, amt) => sum + amt, 0) : 0;
                    }
                    
                    // Get bank deposit data for this entry
                    const bankDeposit = getBankDeposit(collectionDate, center.name, mode);
                    if (bankDeposit) {
                        modeData.depositDate = bankDeposit.depositDate;
                        modeData.depositAmount = bankDeposit.depositAmount;
                    } else {
                        modeData.depositDate = '';
                        modeData.depositAmount = '';
                    }
                });
                
                // Get remark for this center
                center.remark = getRemark(collectionDate, center.name);
                
                // Overall center statistics
                center.minReceipt = center.receipts.length > 0 ? Math.min(...center.receipts) : 0;
                center.maxReceipt = center.receipts.length > 0 ? Math.max(...center.receipts) : 0;
                center.totalReceipts = center.receipts.length;
                center.totalCancelledReceipts = center.cancelledReceipts.length;
                center.totalCancelledAmount = center.cancelledAmounts.reduce((sum, amt) => sum + amt, 0);
                
                return center;
            });
            
            return centers;
        }
        
        // Generate table rows from processed data
        function generateTableRows(centers, selectedDate) {
            const tableBody = document.getElementById('tableBody');
            currentCentersData = centers;
            currentCollectionDate = formatDateForFileName(selectedDate);
            
            if (centers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #718096;">
                            <i class="fas fa-database" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            No data found for the selected date
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = '';
            const formattedDate = formatDateForDisplay(selectedDate);
            const collectionDateStr = formatDateForFileName(selectedDate);
            
            centers.forEach(center => {
                // Calculate total deposit amount for this center
                let centerTotalDepositAmount = 0;
                const centerDepositEntries = [];
                
                // First pass: collect all deposit amounts for this center
                MODES.forEach(mode => {
                    if (mode !== 'Total') {
                        const bankDeposit = getBankDeposit(collectionDateStr, center.name, mode);
                        if (bankDeposit && bankDeposit.depositAmount) {
                            centerDepositEntries.push({
                                mode: mode,
                                amount: parseFloat(bankDeposit.depositAmount) || 0
                            });
                        }
                    }
                });
                
                // Add collection center header row
                const centerRow = document.createElement('tr');
                centerRow.innerHTML = `
                    <td class="collection-center" colspan="11">${center.name}</td>
                `;
                tableBody.appendChild(centerRow);
                
                // Add rows for each mode
                MODES.forEach(mode => {
                    const modeData = center.modes[mode];
                    const modeRow = document.createElement('tr');
                    
                    // Apply highlight-total class to entire row for Total rows
                    if (mode === 'Total') {
                        modeRow.className = 'highlight-total';
                    } else {
                        modeRow.className = 'mode-row';
                    }
                    
                    // Get receipt from/to values
                    const receiptFrom = modeData.minReceipt > 0 ? modeData.minReceipt : '-';
                    const receiptTo = modeData.maxReceipt > 0 ? modeData.maxReceipt : '-';
                    const receiptCount = modeData.count > 0 ? modeData.count : '-';
                    
                    // Format amounts without commas
                    const formatAmount = (amount) => {
                        if (amount === '' || amount === null || amount === undefined || amount === 0) return '-';
                        return Math.round(amount).toString();
                    };
                    
                    // For Cash mode: Get cancelled receipt data from CSV
                    let cancelledReceiptCount = '-';
                    let cancelledAmount = '-';
                    
                    if (mode === 'Cash') {
                        cancelledReceiptCount = modeData.cancelledCount > 0 ? modeData.cancelledCount : '-';
                        cancelledAmount = modeData.cancelledAmount > 0 ? formatAmount(modeData.cancelledAmount) : '-';
                    } else if (mode === 'Total') {
                        // For Total row, show overall cancelled receipts
                        cancelledReceiptCount = center.totalCancelledReceipts > 0 ? center.totalCancelledReceipts : '-';
                        cancelledAmount = center.totalCancelledAmount > 0 ? formatAmount(center.totalCancelledAmount) : '-';
                    }
                    
                    // Handle Deposited In Bank cells
                    let depositDateValue = modeData.depositDate || '';
                    let depositAmountValue = modeData.depositAmount || '';
                    
                    // For Total row, calculate sum of all modes
                    if (mode === 'Total') {
                        // Calculate total deposit amount for this center
                        centerTotalDepositAmount = 0;
                        MODES.forEach(m => {
                            if (m !== 'Total') {
                                const deposit = getBankDeposit(collectionDateStr, center.name, m);
                                if (deposit && deposit.depositAmount) {
                                    centerTotalDepositAmount += parseFloat(deposit.depositAmount) || 0;
                                }
                            }
                        });
                        
                        // For Total row, show the latest deposit date if available
                        const allDeposits = bankDepositData.filter(d => 
                            d.collectionDate === collectionDateStr && 
                            d.centerCode === center.name
                        );
                        
                        if (allDeposits.length > 0) {
                            // Find the latest deposit date
                            const dates = allDeposits
                                .filter(d => d.depositDate)
                                .map(d => new Date(d.depositDate))
                                .filter(d => !isNaN(d.getTime()));
                            
                            if (dates.length > 0) {
                                const latestDate = new Date(Math.max(...dates));
                                depositDateValue = latestDate.toISOString().split('T')[0];
                            }
                        }
                        
                        depositAmountValue = centerTotalDepositAmount > 0 ? centerTotalDepositAmount : '';
                    }
                    
                    const depositDateCell = `
                        <td class="editable-cell date-cell" 
                            data-collection-date="${collectionDateStr}"
                            data-center="${center.name}"
                            data-mode="${mode}"
                            data-type="depositDate"
                            data-value="${depositDateValue}">
                            ${depositDateValue ? formatDateForDisplay(new Date(depositDateValue)) : '-'}
                            <span class="edit-icon"><i class="fas fa-edit"></i></span>
                        </td>
                    `;
                    
                    const depositAmountCell = `
                        <td class="editable-cell amount-cell"
                            data-collection-date="${collectionDateStr}"
                            data-center="${center.name}"
                            data-mode="${mode}"
                            data-type="depositAmount"
                            data-value="${depositAmountValue}">
                            ${depositAmountValue ? formatAmount(depositAmountValue) : '-'}
                            <span class="edit-icon"><i class="fas fa-edit"></i></span>
                        </td>
                    `;
                    
                    // Handle Remark cell
                    let remarkCell = '';
                    if (mode === 'Cash') {
                        const remarkValue = center.remark || '';
                        const formattedRemark = remarkValue ? remarkValue.replace(/\n/g, '<br>') : '';
                        remarkCell = `
                            <td class="remark-editable-cell remark-cell" rowspan="4"
                                data-collection-date="${collectionDateStr}"
                                data-center="${center.name}"
                                data-type="remark"
                                data-value="${remarkValue}">
                                ${formattedRemark || ''}
                                <span class="edit-icon" style="right: 10px;"><i class="fas fa-edit"></i></span>
                            </td>
                        `;
                    }
                    
                    // Generate row
                    modeRow.innerHTML = `
                        <td class="date-cell">${formattedDate}</td>
                        <td>${receiptFrom}</td>
                        <td>${receiptTo}</td>
                        <td class="mode-label">${mode}</td>
                        <td>${receiptCount}</td>
                        <td class="amount-cell">${formatAmount(modeData.amount)}</td>
                        ${depositDateCell}
                        ${depositAmountCell}
                        <td>${cancelledReceiptCount}</td>
                        <td class="amount-cell">${cancelledAmount}</td>
                        ${remarkCell}
                    `;
                    tableBody.appendChild(modeRow);
                });
            });
            
            // Update edit mode
            updateEditMode();
        }
        
        // Enable edit mode
        function enableEditMode() {
            isEditModeActive = true;
            
            // Update UI
            document.getElementById('editModeIndicator').style.display = 'flex';
            document.getElementById('lockEditBtn').style.display = 'none';
            document.getElementById('unlockEditBtn').style.display = 'flex';
            
            // Make all editable cells directly editable
            const editableCells = document.querySelectorAll('.editable-cell, .remark-editable-cell');
            editableCells.forEach(cell => {
                cell.style.backgroundColor = '#f0fff4';
                cell.style.border = '1px solid #68d391';
                
                // Remove edit icon since cells are directly editable
                const editIcon = cell.querySelector('.edit-icon');
                if (editIcon) {
                    editIcon.style.display = 'none';
                }
                
                // Add direct click to edit functionality
                cell.addEventListener('click', handleCellClick);
            });
            
            showNotification('Edit mode activated! You can now edit Deposit Date, Amount (all modes), and Remarks.', 'success');
        }
        
        // Disable edit mode
        function disableEditMode() {
            isEditModeActive = false;
            
            // Update UI
            document.getElementById('editModeIndicator').style.display = 'none';
            document.getElementById('lockEditBtn').style.display = 'flex';
            document.getElementById('unlockEditBtn').style.display = 'none';
            
            // Restore normal cell appearance
            const editableCells = document.querySelectorAll('.editable-cell, .remark-editable-cell');
            editableCells.forEach(cell => {
                cell.style.backgroundColor = '';
                cell.style.border = '';
                
                // Restore edit icon
                const editIcon = cell.querySelector('.edit-icon');
                if (editIcon) {
                    editIcon.style.display = '';
                }
                
                // Remove direct click handler
                cell.removeEventListener('click', handleCellClick);
            });
            
            showNotification('Edit mode disabled. Enter password to edit again.', 'info');
        }
        
        // Update edit mode based on current state
        function updateEditMode() {
            if (isEditModeActive) {
                enableEditMode();
            } else {
                disableEditMode();
            }
        }
        
        // Handle cell click in edit mode
        function handleCellClick(event) {
            if (!isEditModeActive) return;
            
            const cell = event.currentTarget;
            const type = cell.dataset.type;
            const currentValue = cell.dataset.value || '';
            const collectionDate = cell.dataset.collectionDate;
            const center = cell.dataset.center;
            const mode = cell.dataset.mode;
            
            let inputType = 'text';
            let placeholder = '';
            
            if (type === 'depositDate') {
                inputType = 'date';
                placeholder = 'YYYY-MM-DD';
            } else if (type === 'depositAmount') {
                inputType = 'number';
                placeholder = 'Enter amount';
            } else if (type === 'remark') {
                inputType = 'text';
                placeholder = 'Enter remark (multiple lines allowed)';
            }
            
            let input;
            if (type === 'remark') {
                input = document.createElement('textarea');
                input.className = 'remark-textarea';
                input.rows = 4;
                input.style.whiteSpace = 'pre-wrap';
                input.style.wordWrap = 'break-word';
                input.style.overflowWrap = 'break-word';
            } else {
                input = document.createElement('input');
                input.type = inputType;
                input.className = 'edit-input';
            }
            
            if (currentValue) {
                if (type === 'depositDate' && currentValue.includes('-')) {
                    input.value = currentValue;
                } else {
                    input.value = currentValue;
                }
            }
            
            input.placeholder = placeholder;
            
            // Replace cell content with input
            const originalContent = cell.innerHTML;
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            
            // Handle input completion
            const saveAndUpdate = () => {
                saveCellValue(cell, input, type, collectionDate, center, mode);
            };
            
            input.addEventListener('blur', saveAndUpdate);
            
            if (type === 'remark') {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        saveAndUpdate();
                    }
                });
            } else {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveAndUpdate();
                    }
                });
            }
        }
        
        // Save cell value
        function saveCellValue(cell, input, type, collectionDate, center, mode) {
            let newValue = input.value.trim();
            
            if (type === 'depositDate') {
                if (newValue) {
                    const date = new Date(newValue);
                    const displayDate = formatDateForDisplay(date);
                    cell.innerHTML = displayDate + 
                        '<span class="edit-icon"><i class="fas fa-edit"></i></span>';
                    cell.dataset.value = newValue;
                } else {
                    cell.innerHTML = '-<span class="edit-icon"><i class="fas fa-edit"></i></span>';
                    cell.dataset.value = '';
                }
            } else if (type === 'depositAmount') {
                if (newValue) {
                    const amount = parseFloat(newValue) || 0;
                    cell.innerHTML = Math.round(amount).toString() + 
                        '<span class="edit-icon"><i class="fas fa-edit"></i></span>';
                    cell.dataset.value = amount.toString();
                } else {
                    cell.innerHTML = '-<span class="edit-icon"><i class="fas fa-edit"></i></span>';
                    cell.dataset.value = '';
                }
            } else if (type === 'remark') {
                const formattedRemark = newValue ? newValue.replace(/\n/g, '<br>') : '';
                cell.innerHTML = (formattedRemark || '') + 
                    '<span class="edit-icon" style="right: 10px;"><i class="fas fa-edit"></i></span>';
                cell.dataset.value = newValue;
            }
            
            // Save to bank deposit data
            const depositDateCell = document.querySelector(`.editable-cell[data-collection-date="${collectionDate}"][data-center="${center}"][data-mode="${mode}"][data-type="depositDate"]`);
            const depositAmountCell = document.querySelector(`.editable-cell[data-collection-date="${collectionDate}"][data-center="${center}"][data-mode="${mode}"][data-type="depositAmount"]`);
            const remarkCell = document.querySelector(`.remark-editable-cell[data-collection-date="${collectionDate}"][data-center="${center}"]`);
            
            const depositDate = depositDateCell ? depositDateCell.dataset.value || '' : '';
            const depositAmount = depositAmountCell ? depositAmountCell.dataset.value || '' : '';
            const remark = remarkCell ? remarkCell.dataset.value || '' : '';
            
            saveBankDepositEntry(collectionDate, center, mode, depositDate, depositAmount, remark);
            
            // Recalculate and update Total row for this center
            updateTotalRowForCenter(collectionDate, center);
            
            // Re-add click handler for edit mode
            if (isEditModeActive) {
                cell.addEventListener('click', handleCellClick);
            }
            
            showNotification('Data saved locally. Click "Save to GitHub" to update repository.', 'success');
        }
        
        // Update Total row for a specific center
        function updateTotalRowForCenter(collectionDate, center) {
            // Find the center's Total row
            const totalRow = document.querySelector(`.highlight-total td[data-collection-date="${collectionDate}"][data-center="${center}"]`);
            if (!totalRow) return;
            
            // Calculate total deposit amount for this center
            let totalDepositAmount = 0;
            MODES.forEach(m => {
                if (m !== 'Total') {
                    const deposit = getBankDeposit(collectionDate, center, m);
                    if (deposit && deposit.depositAmount) {
                        totalDepositAmount += parseFloat(deposit.depositAmount) || 0;
                    }
                }
            });
            
            // Find the deposit amount cell in the Total row
            const totalAmountCell = document.querySelector(`.highlight-total .editable-cell[data-collection-date="${collectionDate}"][data-center="${center}"][data-mode="Total"][data-type="depositAmount"]`);
            if (totalAmountCell) {
                totalAmountCell.dataset.value = totalDepositAmount > 0 ? totalDepositAmount.toString() : '';
                totalAmountCell.innerHTML = totalDepositAmount > 0 ? Math.round(totalDepositAmount).toString() + 
                    '<span class="edit-icon"><i class="fas fa-edit"></i></span>' : 
                    '-<span class="edit-icon"><i class="fas fa-edit"></i></span>';
            }
            
            // Update the deposit date in Total row (show latest date)
            const allDeposits = bankDepositData.filter(d => 
                d.collectionDate === collectionDate && 
                d.centerCode === center
            );
            
            let latestDate = '';
            if (allDeposits.length > 0) {
                const dates = allDeposits
                    .filter(d => d.depositDate)
                    .map(d => new Date(d.depositDate))
                    .filter(d => !isNaN(d.getTime()));
                
                if (dates.length > 0) {
                    const latest = new Date(Math.max(...dates));
                    latestDate = latest.toISOString().split('T')[0];
                }
            }
            
            const totalDateCell = document.querySelector(`.highlight-total .editable-cell[data-collection-date="${collectionDate}"][data-center="${center}"][data-mode="Total"][data-type="depositDate"]`);
            if (totalDateCell) {
                totalDateCell.dataset.value = latestDate;
                totalDateCell.innerHTML = (latestDate ? formatDateForDisplay(new Date(latestDate)) : '-') + 
                    '<span class="edit-icon"><i class="fas fa-edit"></i></span>';
            }
        }
        
        // Open password modal
        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordInput').focus();
            document.getElementById('passwordInput').value = '';
        }
        
        // Close password modal
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }
        
        // Open GitHub config modal
        function openGitHubConfigModal() {
            document.getElementById('githubConfigModal').style.display = 'flex';
            document.getElementById('githubTokenInput').value = GITHUB_CONFIG.TOKEN || '';
            document.getElementById('githubUserInput').value = GITHUB_CONFIG.USER;
            document.getElementById('githubRepoInput').value = GITHUB_CONFIG.REPO;
            document.getElementById('githubBranchInput').value = GITHUB_CONFIG.BRANCH;
            document.getElementById('githubFileName').value = GITHUB_CONFIG.FILE_NAME;
            document.getElementById('githubTokenInput').focus();
        }
        
        // Close GitHub config modal
        function closeGitHubConfigModal() {
            document.getElementById('githubConfigModal').style.display = 'none';
        }
        
        // Save GitHub configuration
        function saveGitHubConfigFromModal() {
            GITHUB_CONFIG.USER = document.getElementById('githubUserInput').value.trim();
            GITHUB_CONFIG.REPO = document.getElementById('githubRepoInput').value.trim();
            GITHUB_CONFIG.BRANCH = document.getElementById('githubBranchInput').value.trim();
            GITHUB_CONFIG.FILE_NAME = document.getElementById('githubFileName').value.trim();
            GITHUB_CONFIG.TOKEN = document.getElementById('githubTokenInput').value.trim();
            
            if (!GITHUB_CONFIG.TOKEN) {
                showNotification('Please enter a GitHub Personal Access Token', 'warning');
                return;
            }
            
            saveGitHubConfig();
            closeGitHubConfigModal();
            showNotification('GitHub configuration saved successfully!', 'success');
        }
        
        // Validate password and enable edit mode
        function validatePasswordAndEnableEditMode() {
            const passwordInput = document.getElementById('passwordInput').value;
            
            if (passwordInput === PASSWORD) {
                closePasswordModal();
                enableEditMode();
            } else {
                showNotification('Incorrect password!', 'warning');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        // Fetch CSV data from GitHub
        async function fetchCSVData(date) {
            const csvUrl = getCsvFileUrl(date);
            const formattedDate = formatDateForFileName(date);
            
            try {
                showNotification(`Loading data for ${formattedDate}...`, 'info');
                
                const urlWithTimestamp = `${csvUrl}?t=${Date.now()}`;
                const response = await fetch(urlWithTimestamp);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Data file CC_${formattedDate}.csv not found in repository`);
                    }
                    throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.trim() === '' || csvText.includes('404: Not Found')) {
                    throw new Error(`Data file CC_${formattedDate}.csv is empty or not found`);
                }
                
                const csvData = parseCSV(csvText);
                
                if (csvData.length === 0) {
                    throw new Error('No valid data found in CSV file');
                }
                
                const processedData = processCSVData(csvData, formattedDate);
                generateTableRows(processedData, date);
                
                showNotification(`Data loaded successfully for ${formattedDate}!`, 'success');
                
                const displayDate = formatDateForDisplay(date);
                document.getElementById('currentDate').textContent = displayDate;
                document.getElementById('currentDateDisplay').textContent = `Data for: ${displayDate}`;
                
                return processedData;
                
            } catch (error) {
                console.error('Error fetching CSV data:', error);
                showNotification(`Error: ${error.message}`, 'warning');
                
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #e53e3e;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            <strong>Error loading data</strong><br>
                            ${error.message}<br>
                            <small style="color: #718096; margin-top: 10px; display: block;">
                                Please check if CC_${formattedDate}.csv exists in the GitHub repository
                            </small>
                        </td>
                    </tr>
                `;
                
                return null;
            }
        }
        
        // Load data button functionality
        document.getElementById('loadDataBtn').addEventListener('click', async function() {
            const selectedDate = document.getElementById('dateFilter').value;
            
            if (!selectedDate) {
                showNotification('Please select a date first', 'warning');
                return;
            }
            
            const date = new Date(selectedDate);
            
            const loadBtn = document.getElementById('loadDataBtn');
            const originalText = loadBtn.innerHTML;
            loadBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px; border-width: 2px;"></div> Loading...';
            loadBtn.disabled = true;
            
            await fetchCSVData(date);
            
            loadBtn.innerHTML = originalText;
            loadBtn.disabled = false;
        });
        
        // Save to GitHub button functionality
        document.getElementById('saveToGitHubBtn').addEventListener('click', async function() {
            const saveBtn = document.getElementById('saveToGitHubBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px; border-width: 2px;"></div> Saving...';
            saveBtn.disabled = true;
            
            await saveToGitHub();
            
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
        
        // Date filter change
        document.getElementById('dateFilter').addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                const date = new Date(selectedDate);
                const formattedDate = formatDateForDisplay(date);
                showNotification(`Date selected: ${formattedDate} - Click Load Data to fetch`, 'info');
                document.getElementById('loadDataBtn').disabled = false;
            }
        });
        
        // Password modal event listeners
        document.getElementById('closePasswordModalBtn').addEventListener('click', closePasswordModal);
        document.getElementById('cancelPasswordBtn').addEventListener('click', closePasswordModal);
        document.getElementById('submitPasswordBtn').addEventListener('click', validatePasswordAndEnableEditMode);
        
        // GitHub config modal event listeners
        document.getElementById('githubConfigBtn').addEventListener('click', openGitHubConfigModal);
        document.getElementById('closeGitHubModalBtn').addEventListener('click', closeGitHubConfigModal);
        document.getElementById('cancelGitHubBtn').addEventListener('click', closeGitHubConfigModal);
        document.getElementById('saveGitHubConfigBtn').addEventListener('click', saveGitHubConfigFromModal);
        
        // Enter key in password input
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validatePasswordAndEnableEditMode();
            }
        });
        
        // Lock/Unlock edit mode buttons
        document.getElementById('lockEditBtn').addEventListener('click', openPasswordModal);
        document.getElementById('unlockEditBtn').addEventListener('click', disableEditMode);
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const passwordModal = document.getElementById('passwordModal');
            const githubModal = document.getElementById('githubConfigModal');
            
            if (event.target === passwordModal) {
                closePasswordModal();
            }
            if (event.target === githubModal) {
                closeGitHubConfigModal();
            }
        });
        
        // Action buttons functionality
        document.getElementById('chequeDataBtn').addEventListener('click', function() {
            window.open('cheque_data.html', '_blank');
            showNotification('Opening Cheque Data in new tab', 'info');
        });
        
        document.getElementById('neftDataBtn').addEventListener('click', function() {
            window.open('neft_data.html', '_blank');
            showNotification('Opening NEFT Data in new tab', 'info');
        });
        
        document.getElementById('bankStatementBtn').addEventListener('click', function() {
            window.open('bank_statement.html', '_blank');
            showNotification('Opening Bank Statement in new tab', 'info');
        });
        
        document.getElementById('dashboardBtn').addEventListener('click', function() {
            window.open('dashboard.html', '_blank');
            showNotification('Opening Dashboard in new tab', 'info');
        });
        
        // Function to show notifications
        function showNotification(message, type) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#27ae60';
                notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            } else if (type === 'info') {
                notification.style.backgroundColor = '#3498db';
                notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#f39c12';
                notification.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Initialize the page
        window.onload = async function() {
            // Load GitHub configuration
            loadGitHubConfig();
            
            // Set today's date as default
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            document.getElementById('dateFilter').value = todayFormatted;
            
            // Update current date display
            const displayDate = formatDateForDisplay(today);
            document.getElementById('currentDate').textContent = displayDate;
            document.getElementById('currentDateDisplay').textContent = `Data for: ${displayDate}`;
            document.getElementById('currentDateDisplay').style.cssText = `
                background: rgba(255, 255, 255, 0.15);
                padding: 10px 20px;
                border-radius: 8px;
                font-weight: 600;
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.25);
            `;
            
            // Load existing bank deposit data
            console.log('Loading bank deposit data from GitHub...');
            await loadBankDepositData();
            
            // Load backup data from localStorage
            try {
                const backup = localStorage.getItem('bankDepositDataBackup');
                if (backup) {
                    const backupData = JSON.parse(backup);
                    console.log(`Found ${backupData.length} backup records in localStorage`);
                    
                    // Merge backup data with loaded data
                    backupData.forEach(backupEntry => {
                        const existingIndex = bankDepositData.findIndex(entry => 
                            entry.collectionDate === backupEntry.collectionDate &&
                            entry.centerCode === backupEntry.centerCode &&
                            entry.mode === backupEntry.mode
                        );
                        
                        if (existingIndex !== -1) {
                            bankDepositData[existingIndex] = backupEntry;
                        } else {
                            bankDepositData.push(backupEntry);
                        }
                    });
                    
                    console.log(`Total bank deposit records: ${bankDepositData.length}`);
                }
            } catch (e) {
                console.log('No valid backup data found in localStorage');
            }
            
            // Initialize edit mode as disabled
            disableEditMode();
            
            // Set up auto-save timer
            autoSaveTimer = setInterval(autoSaveData, 30000);
            window.addEventListener('beforeunload', autoSaveData);
        };
        
        // Clean up timer when page is unloaded
        window.addEventListener('unload', function() {
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }
        });
    </script>
</body>
</html>